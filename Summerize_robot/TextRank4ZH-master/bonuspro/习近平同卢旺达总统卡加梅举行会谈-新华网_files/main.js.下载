/**
 * @author	jiangyannian
 * @modify wangxiaokang
 * @version	1.0
 * @time	2016-12-22
 * @update	2017-07-28 
 * @description	新华网2017领导人
 */

$(function () {

	var $body = $("body");
	var Module = function () {
		var metaArr = $("meta[name='pageid']").attr("content").split(".");
		var siteIdXml = metaArr[0];
		var nodeId = metaArr[4];
		var releaseDate = $(".h-time").html();
		var fileUUID = metaArr[11];		//稿件id

		var newsHref = window.location.href; //当前文章地址
		var channelName = newsHref.split("/")[3];

		this.dateDiff = function (hisTime, nowTime) {
			hisTime = new Date(hisTime.replace(/-/g, "/")).getTime();
			var now = nowTime ? nowTime : new Date().getTime(),
				diffValue = now - hisTime,
				result = '',
				minute = 1000 * 60,
				hour = minute * 60,
				day = hour * 24,
				halfamonth = day * 15,
				month = day * 30,
				year = month * 12,
				_year = diffValue / year,
				_month = diffValue / month,
				_week = diffValue / (7 * day),
				_day = diffValue / day,
				_hour = diffValue / hour,
				_min = diffValue / minute;
			if (_year >= 1) result = parseInt(_year) + "年前";
			else if (_month >= 1) result = parseInt(_month) + "个月前";
			else if (_week >= 1) result = parseInt(_week) + "周前";
			else if (_day >= 1) result = parseInt(_day) + "天前";
			else if (_hour >= 1) result = parseInt(_hour) + "个小时前";
			else if (_min >= 5) result = parseInt(_min) + "分钟前";
			else result = "刚刚";
			return result;
		}

		/*header 关联块滞留*/
		this.roedeer = function () {
			var _rd = this;
			_rd.init = function (arr) {
				//$(".roedeer-links-container > div").css("display","none");
				$(arr).each(function (i, v) {
					var cName = "roedeer-active" + i;
					$(v).on("mouseover", function () {
						$(v).addClass(cName + " active");
					}).on("mouseleave", function () {
						$(v).removeClass(cName + " active");
					});
				});
			};
		};

		/*分享*/
		this.share = function () {
			var href = window.location.href;
			//var href = 'http://m.news.cn/politics/2017-01/02/c_1120230321.htm';
			var title = $(".h-title").html();
			$(".s-wb").on("click", function () {
				window.open('http://service.weibo.com/share/share.php?url=' + href + "&title=" + title);
			});
			$(".s-q").on("click", function () {
				window.open('http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=' + href + "&title=" + title)
			})
			$(".share-wx-item").on("mouseover", function () {
				$(".wx-ewm").stop(true, true).slideDown();
			}).on("mouseleave", function () {
				$(".wx-ewm").stop(true, true).slideUp();
			});

			var _src = href.replace("c_", "ewm_").replace(".htm", "1n.jpg");
			$(".wx-ewm img").attr("src", _src);
		};
		/*检索*/
		this.search = function (kw) {
			if (!kw) {
				kw = $("#kw").val();
			}
			if (kw) {
				window.open("http://so.news.cn/#search/0/" + kw + "/1/");
			}
		};

		this.jiucuo = function () {
			(function () {
				var _hexCHS = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
				var _hexTBL = { '0': 0, '1': 1, '2': 2, '3': 3, '4': 4, '5': 5, '6': 6, '7': 7, '8': 8, '9': 9, 'A': 10, 'B': 11, 'C': 12, 'D': 13, 'E': 14, 'F': 15, 'G': 16, 'H': 17, 'I': 18, 'J': 19, 'K': 20, 'L': 21, 'M': 22, 'N': 23, 'O': 24, 'P': 25, 'Q': 26, 'R': 27, 'S': 28, 'T': 29, 'U': 30, 'V': 31, 'W': 32, 'X': 33, 'Y': 34, 'Z': 35, 'a': 36, 'b': 37, 'c': 38, 'd': 39, 'e': 40, 'f': 41, 'g': 42, 'h': 43, 'i': 44, 'j': 45, 'k': 46, 'l': 47, 'm': 48, 'n': 49, 'o': 50, 'p': 51, 'q': 52, 'r': 53, 's': 54, 't': 55, 'u': 56, 'v': 57, 'w': 58, 'x': 59, 'y': 60, 'z': 61 };
				var key = [61, 37, 44, 31, 34, 7, 24, 6, 43, 12, 27, 3, 25, 29, 60, 33, 35, 41, 58, 2, 51, 49, 9, 5, 59, 11, 42, 32, 22, 40, 4, 57, 50, 38, 8, 56, 21, 19, 52, 53, 16, 28, 1, 26, 47, 17, 54, 46, 10, 23, 55, 13, 14, 20, 15, 36, 18];
				Hr = function () {
					if (key.length < 57) { throw new Error('the key is too short.'); }
					this._sz = _hexCHS.charCodeAt(key[15]) % (key.length - 20) + 10; this._ks = key.slice(-this._sz);
					for (var _i = 0; _i < this._sz; ++_i) { this._ks[_i] = _hexCHS.charCodeAt(this._ks[_i] % 62); }
					this._k16 = [], this._k41 = []; this._t16 = {}, this._t41 = {};
					for (var _i = 0; _i < 16; ++_i) { this._k16[_i] = _hexCHS.charAt(key[_i]); this._t16[this._k16[_i]] = _i; }
					for (var _i = 0; _i < 41; ++_i) { this._k41[_i] = _hexCHS.charAt(key[_i + 16]); this._t41[this._k41[_i]] = _i; }
				};
				Hr.prototype.ca = function (s) { var _k16 = this._k16, _k41 = this._k41, _ks = this._ks, _sz = this._sz, _cnt = 0; return s.replace(/[^\s\n\r]/g, function (ch) { var _n = ch.charCodeAt(0); return (_n <= 0xff) ? _k16[parseInt(_n / 16)] + _k16[_n % 16] : _k41[parseInt(_n / 1681)] + _k41[parseInt(_n % 1681 / 41)] + _k41[_n % 41] }).replace(/[0-9A-Za-z]/g, function (ch) { return _hexCHS.charAt((_hexTBL[ch] + _ks[_cnt++ % _sz]) % 62); }); };
			})();

			$(".tiyi1").click(function () {
				$('#jc_link1').attr("src", jc_link);
				$("#advisebox01").show();
			});
			$("#jc_close1").click(function () {
				event.stopPropagation();
				$("#advisebox01").hide();
			});

			$("#jc_close1").click(function () { $("#advisebox01").hide(); });
			$("#jc_close2").click(function () { $("#advisebox02").hide(); });
			//获取责编id，稿件url，稿件id，稿件标题  
			var ele_pageid = $("meta[name=pageid]").attr("content");
			var ele_ids = ele_pageid.split(".");
			var bId = ele_ids[ele_ids.length - 2];
			var _code = new Hr();//code
			var cId = _code.ca(ele_ids[ele_ids.length - 1]);
			var cTitle = $("title").html().split("_")[0];
			if (cTitle != "") { cTitle = encodeURI(encodeURI(cTitle)); }
			var cUrl = window.location.href;
			var jc_link = 'http://ck.wa.news.cn/XHWCIFB/Confirm.do?bId=' + bId + "&cUrl=" + cUrl + "&cId=" + cId + "&cTitle=" + cTitle;
			/****** end *******/
		};
		//触发窗口卷边多1像素 用于兼容页面因高度变化引起的scrolltop事件未触发
		this.reScroll = function () {
			$(window).scrollTop(1 + $(window).scrollTop());
		};
		//时间格式处理
		this.turnTime = function (cont) {
			var _this = this;
			$(cont).each(function (i, v) {
				var $v = $(v);
				$v.html(_this.dateDiff($v.html()));
			});
		};
		//关键词检索
		this.searchKW = function () {
			var _this = this;
			$(".search").on("click", function () {
				_this.search()
			});
			$("#kw").on('keydown', function (e) {
				var e = e || window.event || event || arguments.callee.caller.arguments[0];
				if (e && e.keyCode == 13) {
					_this.search();
				}
			});
			var k = "";
			$($('meta[name="keywords"]').attr("content").split(",")).each(function (i, v) {
				k += '<a href="javascript:void(0);">' + v + '</a>'
			});
			$(".p-kwap").html(k);
			$(".p-kwap a").on("click", function () {
				_this.search($(this).html());
			});


			$body.on("click", ".search-kw", function (e) {
				_this.search($(this).html());
			});
		};

		//二维码
		this.ewmFun = function () {
			var $f = $(".c-wx");
			$f.html('<img src="http://www.newsimg.cn/xl2017/images/wx.png" style="width:100%;height:100%;">')
			$(".f-wx").on("mouseover", function () {
				$(".c-wx").fadeIn();
			}).on("mouseout", function () {
				$(".c-wx").fadeOut();
			})
		};

		//导航滚动跟随
		this.streamlineFollow = function () {
			var $header = $(".header");
			var headerHeight = $header.height();
			var headerTop = +$header.css("margin-top").split("px")[0];
			var headerBottom = +$header.css("margin-bottom").split("px")[0];
			var headerTotalHeight = headerHeight + headerTop + headerBottom;
			var f1Height = $("#fllow1").height();
			var rightAdHeight = null;
			$(window).scroll(function () {
				var windowHeight = $(window).height();
				var scrollTop = $(window).scrollTop();
				var heightP1 = $(".part1").height();	 //第一部分高
				$(".fllow1-wap").height(heightP1 + "px");
				//左侧广告1
				if (scrollTop >= headerHeight) {
					$('#fllow1').removeClass("hold").addClass("fixed");
					//80 是fllow1距离part1底部的空白间距
					if (headerTotalHeight + heightP1 - f1Height - headerBottom - 80 < scrollTop) {
						$("#fllow1").addClass("hold").removeClass("fixed");
					}
				} else {
					$("#fllow1").removeClass("fixed hold");
				}

			});
		};

		// 字数统计
		this.wordCount = function () {
			var words = $('.main-aticle').text().trim();
			var length = words.length;
			var minute = Math.ceil(length / 280);

			$('.word-num').text(length);
			$('.read-time').text(minute)
		};

		// 图片加链接和导航
		this.makePicNavAndLink = function () {
			var $pic = $('.main-aticle').find('img').eq(0);
			var $parent = $pic.parent();

			// 图片链接
			var $link = $(document.createElement('a'));

			$link.css({
				position: 'relative',
				display: 'block'
			});

			// 图片导航
			var $preBtn = $('<a class="btn-pre">&lt;</a>');
			var $nextBtn = $('<a class="btn-next">&gt;</a>');

			// 获取链接
			var $curPage = $('#div_currpage').find('span');
			var nextLink = $curPage.next().attr('href');
			var preLink = $curPage.prev().attr('href');

			// .attr('href', nextLink)

			$link.append($pic).appendTo($parent);

			if (nextLink) {
				$link.attr('href', nextLink)
					.append($nextBtn.attr('href',nextLink));
			}

			if (preLink) {
				$link.append($preBtn.attr('href',preLink));
			}
		};

		//简版执行脚本 
		this.streamlineInit = function () {
			var _this = this;
			var rd = new _this.roedeer();
			rd.init([".nav-khd", ".nav-ss", ".nav-pd"]);
			_this.wordCount(); //统计阅读时间
			_this.share();
			//_this.xs();							/*右侧炫图 视频切换*/
			_this.turnTime(".publish-time");	//时间格式处理
			_this.searchKW(); 					//关键词检索
			_this.ewmFun();						//二维码
			_this.jiucuo();						//纠错 
			//_this.fuchuang();					//浮窗新闻
			//_this.streamlineFollow();			//导航滚动跟随
			_this.makePicNavAndLink();

		};

		//移动端初始化
		this.mobileInit = function () {
			var _this = this;
			$(".fllow3-wap, .nav, .part2, .bottom, .fllow1-wap, .lb,.r-des,.r-in,.zan-wap, .p-tags, .footer").remove();
			var temp = "<div class='m-page'>" +
				"<header class='m-header'>" +
				'<a href="http://m.news.cn/index.htm" class="m-logo"></a>' +
				'<div class="m-nav"></div>' +
				"</header>" +
				"<div class='m-title'>" + $(".h-title").html() + " </div>" +
				"<div class='m-info'>" + $(".h-info").html() + " </div>" +
				"<div class='m-detail'>" + $("#p-detail").html() + " </div>" +


				"<section class='m-qr-code'>" +
				"<div class='img-full'><img src='http://www.xinhuanet.com/m/img/weixinQRcode.png'></div>" +
				"<p class='txt'>微信扫描二维码，关注新华网</p>" +
				"</section>";

			$body.append(temp).show().addClass("mobile").removeClass('streamline-page');

			// 插入pc banner
			var $topBanner = $('.top-banner');
			// 换手机端图片
			$topBanner.find('img')[0].src = "http://www.newsimg.cn/xjp20171103/images/mb_xjp_banner.jpg";
			$('.m-header').after($topBanner);

			$('.header, .main').remove();

			//弹出层链接
			(function () {
				var netMap = '<div class="m-container"><div class="nav-more-content show"><div class="m-close"></div>' +
					'<div class="nav-list-head"><div class="nav-close ico-add"></div></div>' +
					'<div class="nav-list-wrapper"><h2>网站地图</h2>' +
					'<ul class="channel-list">' +
					'<li><a href="http://m.news.cn/politics/index.htm">新闻</a></li>' +
					'<li><a href="http://m.news.cn/fortune/index.htm">财经</a></li>' +
					'<li><a href="http://m.news.cn/world/index.htm">国际</a></li>' +
					'<li><a href="http://m.news.cn/ent/index.htm">娱乐</a></li>' +
					'<li><a href="http://m.news.cn/photo/index.htm">图片</a></li>' +
					'<li><a href="http://m.news.cn/forum/index.htm">社区</a></li>' +
					'<li><a href="http://m.news.cn/mil/index.htm">军事</a></li>' +
					'<li><a href="http://m.news.cn/sports/index.htm">体育</a></li>' +
					'<li><a href="http://m.news.cn/tech/index.htm">前沿</a></li>' +
					'<li><a href="http://m.news.cn/edu/index.htm">教育</a></li>' +
					'<li><a href="http://m.news.cn/comments/index.htm">网评</a></li>' +
					'<li><a href="http://m.news.cn/gangao/index.htm">港澳台</a></li>' +
					'<li><a href="http://m.news.cn/legal/index.htm">法治</a></li>' +
					'<li><a href="http://m.news.cn/society/index.htm">社会</a></li>' +
					'<li><a href="http://m.news.cn/culture/index.htm">文化</a></li>' +
					'<li><a href="http://m.news.cn/fashion/index.htm">时尚</a></li>' +
					'<li><a href="http://m.news.cn/travel/index.htm">旅游</a></li>' +
					'<li><a href="http://m.news.cn/health/index.htm">健康</a></li>' +
					'<li><a href="http://m.news.cn/auto/index.htm">汽车</a></li>' +
					'<li><a href="http://m.news.cn/house/index.htm">房产</a></li>' +
					'<li><a href="http://m.news.cn/food/index.htm">美食</a></li>' +
					'<li><a href="http://m.news.cn/book/index.htm">悦读</a></li>' +
					'<li><a href="http://m.news.cn/video/index.htm">视频</a></li>' +
					'<li><a href="http://www.xinhuanet.com/video/xinhuaradio/mobile.htm">广播</a></li>' +
					'<li><a href="http://m.xinhuanet.com/science/index.htm">科普</a></li>' +
					'</ul>' +
					'<h2>品牌栏目</h2><ul class="topic-list">' +
					'<li><a href="http://www.xinhuanet.com/politics/xxjxs/mobile.htm">学习进行时</a></li>' +
					'<li><a href="http://www.xinhuanet.com/politics/rs.htm">人事任免</a></li>' +
					'<li><a href="http://sike.xinhuanet.com/static/index.html">思客</a></li>' +
					'<li><a href="http://www.xinhuanet.com/datanews/web.htm">数据新闻</a></li>' +
					'<li><a href="http://uav.xinhuanet.com/">无人机</a></li></ul>' +
					'<h2>地方频道</h2><ul class="location-list">' +
					'<li><a href="http://m.xinhuanet.com/bj.htm">北京</a></li>' +
					'<li><a href="http://m.xinhuanet.com/tj.htm">天津</a></li>' +
					'<li><a href="http://m.xinhuanet.com/he.htm">河北</a></li>' +
					'<li><a href="http://m.xinhuanet.com/sx.htm">山西</a></li>' +
					'<li><a href="http://m.xinhuanet.com/ln.htm">辽宁</a></li>' +
					'<li><a href="http://m.xinhuanet.com/jl.htm">吉林</a></li>' +
					'<li><a href="http://m.xinhuanet.com/sh.htm">上海</a></li>' +
					'<li><a href="http://m.xinhuanet.com/js.htm">江苏</a></li>' +
					'<li><a href="http://m.xinhuanet.com/zj.htm">浙江</a></li>' +
					'<li><a href="http://m.xinhuanet.com/ah.htm">安徽</a></li>' +
					'<li><a href="http://m.xinhuanet.com/fj.htm">福建</a></li>' +
					'<li><a href="http://m.xinhuanet.com/jx.htm">江西</a></li>' +
					'<li><a href="http://m.xinhuanet.com/sd.htm">山东</a></li>' +
					'<li><a href="http://m.xinhuanet.com/ha.htm">河南</a></li>' +
					'<li><a href="http://m.xinhuanet.com/hb.htm">湖北</a></li>' +
					'<li><a href="http://m.xinhuanet.com/hn.htm">湖南</a></li>' +
					'<li><a href="http://m.xinhuanet.com/gd.htm">广东</a></li>' +
					'<li><a href="http://m.xinhuanet.com/gx.htm">广西</a></li>' +
					'<li><a href="http://m.xinhuanet.com/hq.htm">海南</a></li>' +
					'<li><a href="http://m.xinhuanet.com/cq.htm">重庆</a></li>' +
					'<li><a href="http://m.xinhuanet.com/sc.htm">四川</a></li>' +
					'<li><a href="http://m.xinhuanet.com/gz.htm">贵州</a></li>' +
					'<li><a href="http://m.xinhuanet.com/yn.htm">云南</a></li>' +
					'<li><a href="http://m.xinhuanet.com/xz.htm">西藏</a></li>' +
					'<li><a href="http://m.xinhuanet.com/sn.htm">陕西</a></li>' +
					'<li><a href="http://m.xinhuanet.com/gs.htm">甘肃</a></li>' +
					'<li><a href="http://m.xinhuanet.com/qh.htm">青海</a></li>' +
					'<li><a href="http://m.xinhuanet.com/nx.htm">宁夏</a></li>' +
					'<li><a href="http://m.xinhuanet.com/xj.htm">新疆</a></li>' +
					'<li><a href="http://m.xinhuanet.com/nmg.htm">内蒙古</a></li>' +
					'<li><a href="http://m.xinhuanet.com/hlj.htm">黑龙江</a></li></ul>' +
					'<h2>多语种频道</h2><ul class="language-list">' +
					'<li><a href="http://xinhuanet.com/english/mobile/index.htm">ENGLISH</a></li>' +
					'<li><a href="http://spanish.xinhuanet.com/mobile/index.htm">Español</a></li>' +
					'<li><a href="http://french.xinhuanet.com/mobile/index.htm">Français</a></li>' +
					'<li><a href="http://jp.xinhuanet.com/m/index.htm">日本語</a></li>' +
					'<li><a href="http://kr.xinhuanet.com/m/index.htm">한국어</a></li>' +
					'<li><a href="http://german.xinhuanet.com/dwpdsjb/index.htm">Deutsch</a></li>' +
					'<li><a href="http://portuguese.xinhuanet.com/mobile/index.htm">Português</a></li>' +
					'<li><a href="http://arabic.news.cn/mobile/index.htm">عربى</a></li>' +
					'<li><a href="http://russian.xinhuanet.com/mobile/index.htm">Русский язык</a></li></ul></div></div></div>';
				$body.append(netMap);
				var $mContainer = $(".m-container");
				$mContainer.hide();
				$(".m-close").on("click", function () {
					$mContainer.fadeOut();
				});
				$(".m-nav").on("click", function () {
					$mContainer.fadeIn();
				});
			})();

			$("body").append($(".m-footer"));

			_this.makePicNavAndLink();
		};
	};
	var m = new Module();
	var isMobile = (/iPad|iPhone|Android|Windows Phone|Nokia/).test(navigator.userAgent);	  //当前访问设备为移动端
	var isLow750 = document.querySelector("body").clientWidth<=750;//判断是否屏幕尺寸小于750，针对pc，小于750展示手机版页面
	if (isMobile||isLow750) {
		m.mobileInit();
		return;
	} else {
		if ($(".streamline-page").length) {
			m.streamlineInit();
		} else {
			m.pcInit();
		}
	}
});